/**
 * lightservice - 
 * @version v6.0.1
Sat Feb 13 2016 10:39:22 GMT-0500 (Eastern Standard Time)
 * @link https://github.com/contactsamie/LightService
 * @license MIT
 * @license sam <contactsamie@gmail.com> Samuel
 */
var light="undefined"==typeof light?function(){function e(e){return"[object Array]"===Object.prototype.toString.call(e)}var t={};t.getCurrentContext=function(e,n,r){var a=r?JSON.parse(JSON.stringify({data:r})).data:r,i={event:t.systemServices,service:g(),arg:n,system:t.system,state:t._STATE_[e].api(a)};return i},t.forbiddenNames={result:!0,service:!0,handle:!0},t.expectNoForbiddenName=function(e){if(t.forbiddenNames[e])throw"You cannot use the name '"+e+"'"},t.registry={service:{},handle:{},scripts:{}},t.isRegistered=function(e){return t.registry.service[e]||t.registry.handle[e]?!0:!1},t.generateUniqueSystemName=function(e){e=e||"";var n=(e+"_xxxxxxxx_xxxx_4xxx_yxxx_xxxxxxxxxxxx").replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"==e?t:3&t|8;return n.toString(16)});return t.isRegistered(n)?t.generateUniqueSystemName(e):n},t.$setState=function(e,n,r){t._STATE_[e].ref[n]={data:r},t._STATE_[e].state[n]=JSON.stringify(t._STATE_[e].ref[n])},t.$getState=function(e){var n=t._STATE_[e];return n&&(t._STATE_[e].state||{})},t.stateFactory=function(e){t._STATE_[e]={state:{},ref:{},api:function(n){return n&&(t._STATE_[e].state=n),{get:function(n){var r=t.$getState(e)[n];return r?JSON.parse(r).data:r},set:function(n,r){t.$setState(e,n,r)},getRef:function(n){return t._STATE_[e].ref[n]=t._STATE_[e].ref[n]||{},t._STATE_[e].ref[n].data}}}}},t.burnThread=function(e){for(var t=(new Date).getTime()+1e3*e;(new Date).getTime()<=t;);},t.loadScript=function(e,n){n?t.loadScriptAsync(e,n):t.loadScriptSync(e)},t.loadScriptAsync=function(e,t){if(!document)throw"Cannot load script : no document";var n=document.createElement("script");n.src=e,n.onload="function"==typeof t?t:function(){},document.getElementsByTagName("head")[0].appendChild(n)},t.loadScriptSync=function(e){if(!document)throw"Cannot load script : no document";var t=r();t.open("GET",e,!1),t.send("");var n=document.createElement("script");n.type="text/javascript",n.text=t.responseText,document.getElementsByTagName("head")[0].appendChild(n)},t.track={record:function(e){if(e.methodName!==t.DEFAULT_HANDLE_NAME){var n={dataType:e.entranceOrExit,methodType:e.serviceOrHandleMethodName,methodName:e.methodName,time:Date.now?Date.now():(new Date).getTime(),isFirst:e.isFirstCallInServiceRun,isLast:e.isLastCallInServiceRun,data:e.argumentOrReturnData,isTest:e.isTest||!1,info:e.info,infoType:e.infoType,link:"function"==typeof e.link?e.link.toString():e.link,state:t.$getState(e.methodName),event:e.event,eventType:e.eventType},r=JSON.stringify(n);t.recordServices&&y[t.systemEventName.onSystemRecordEvent].notify(r),e.serviceOrHandleMethodName===t.serviceTag&&(t.systemServices[e.methodName][t.serviceEventName[e.eventType]].notify(r),(e.eventType===t.serviceEventName.error||e.eventType===t.serviceEventName.success)&&t.systemServices[e.methodName][t.serviceEventName[t.serviceEventName.after]].notify(r)),y[e.event].notify(r),y[t.systemEventName.onSystemEvent].notify(r)}}},t.utility={execSurpressError:function(e,t,n,r){if("function"==typeof e)try{e(t,n,r)}catch(a){console.error("SUPRESSED ERROR : "+a)}},tryCatch:function(e,n,r,a){try{var i=n();t.utility.execSurpressError(function(){r(i,e)},null,e,"trying-service")}catch(s){t.utility.execSurpressError(function(){a(s,e)},s,e,"service-throws")}}};var n=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}],r=function(){for(var e=!1,t=0;t<n.length;t++){try{e=n[t]()}catch(r){continue}break}return e},a=function(e,n){return a.ref=a.ref||0,a.ref++,t.eventSubscribers[e]=t.eventSubscribers[e]||{},t.eventSubscribers[e].sub=t.eventSubscribers[e].sub||[],t.eventSubscribers[e].sub.push({service:n,ref:a.ref}),a.ref},i=function(e,n){t.eventSubscribers[e]=t.eventSubscribers[e]||{},t.eventSubscribers[e].sub=t.eventSubscribers[e].sub||[],t.eventSubscribers[e].notify=t.eventSubscribers[e].notify||function(r,a,i){for(var s=e,o=t.eventSubscribers[s].sub.length,c=0;o>c;c++){var u=t.eventSubscribers[s].sub[c],v={index:c,notificationType:i};n(u,r,a,v)}}},s=function(e){return i(e,function(e,n,r,a){t.utility.tryCatch(r,function(){return e.service()},function(){},function(){t.utility.execSurpressError(e.service.error,n,r,a)})})},o=function(e,t,n){e[t]=function(e){a(n,e)},i(n,function(e,t,n,r){if(e&&"function"==typeof e.service)try{e.service(t,n,r)}catch(a){}})},c=function(e,n,r){o(e,n,r+"."+n),e[n].notify=t.eventSubscribers[r+"."+n].notify},u=function(e,n,r){e[n]=function(e){return a(r,e)},e[n].forEachSubscriber=e[n].forEachSubscriber||function(e){for(var n=t.eventSubscribers[r].sub.length,a=0;n>a;a++){var i=t.eventSubscribers[r].sub[a];e&&e(i)}},s(r),e[n].notify=t.eventSubscribers[r].notify},v=function(e,n,r,a,i){var s=t._TEST_OBJECTS_&&t._TEST_OBJECTS_[a]&&t._TEST_OBJECTS_[a].handleName,o=t._TEST_OBJECTS_&&t._TEST_OBJECTS_[a]&&t._TEST_OBJECTS_[a].handle;return t.track.record({entranceOrExit:t.entranceTag,serviceOrHandleMethodName:t.handleTag,methodName:s,argumentOrReturnData:a,info:i,infoType:t.serviceArgTag,isTest:!0,isFirstCallInServiceRun:t.unknownTag,isLastCallInServiceRun:t.unknownTag,link:o,event:t.systemEventName.beforeHandleRun,eventType:t.serviceEventName.before}),tmpDefinition=o.call(t.getCurrentContext(a,r),r),t.track.record({entranceOrExit:t.exitTag,serviceOrHandleMethodName:t.handleTag,methodName:s,argumentOrReturnData:a,info:t.unknownTag,infoType:t.unknownTag,isTest:!0,isFirstCallInServiceRun:t.unknownTag,isLastCallInServiceRun:t.unknownTag,link:o,event:t.systemEventName.afterHandleRun,eventType:t.serviceEventName.after}),tmpDefinition},f=function(e,n,r,a,i,s,o,c){c&&(r=c);for(var u=!1,v=t.handles.length,f=0;v>f;f++){var m=t.handles[f];if(u=r&&m.name===r){t.track.record({entranceOrExit:t.entranceTag,serviceOrHandleMethodName:t.handleTag,methodName:r,argumentOrReturnData:i,info:s,infoType:t.serviceArgTag,isTest:!1,isFirstCallInServiceRun:t.unknownTag,isLastCallInServiceRun:t.unknownTag,link:o||m.definition,event:t.systemEventName.beforeHandleRun,eventType:t.serviceEventName.before}),tmpDefinition=(o||m.definition).call(t.getCurrentContext(r,a),a),t.track.record({entranceOrExit:t.exitTag,serviceOrHandleMethodName:t.handleTag,methodName:r,argumentOrReturnData:i,info:t.unknownTag,infoType:t.unknownTag,isTest:!1,isFirstCallInServiceRun:t.unknownTag,isLastCallInServiceRun:t.unknownTag,link:o||m.definition,event:t.systemEventName.afterHandleRun,eventType:t.serviceEventName.after});break}}return tmpDefinition},m=function(e,n,r,a,i,s){var o,c=t._TEST_OBJECTS_&&t._TEST_OBJECTS_[i]&&t._TEST_OBJECTS_[i].handleName,u=t._TEST_OBJECTS_&&t._TEST_OBJECTS_[i]&&t._TEST_OBJECTS_[i].handle;return o=u&&!c?v(e,n,a,i,s):f(e,n,r,a,i,s,u,c)},l=function(n,r,a,i,s,o){t._TEST_OBJECTS_&&t._TEST_OBJECTS_[s]&&t._TEST_OBJECTS_[s].service&&(a=t._TEST_OBJECTS_[s].handleNames||a,i=t._TEST_OBJECTS_[s].service||i),a=e(a)?a:a?[a]:[];var c,u=a.length;c=o;for(var v=0;u>v;v++){var f=a[v],l=m(n,r,f,i,s,c);if("function"!=typeof l){var T="Cannot process service or handle '"+s+"' ";throw T+=l?"'"+f+"' service handle must return a function":"no matching service handle  exists ",console.error(T),T}c=l.call(t.getCurrentContext(s,c),c)}return c},T=function(e,n,r,a,i){return u(n,t.serviceEventName.before,i+"."+t.serviceEventName.before),u(n,t.serviceEventName.after,i+"."+t.serviceEventName.after),u(n,t.serviceEventName.error,i+"."+t.serviceEventName.error),u(n,t.serviceEventName.success,i+"."+t.serviceEventName.success),function(s,o){var c={};c.arg=s;var u;return e.callerContext=o,t.utility.tryCatch(e,function(){t.track.record({entranceOrExit:t.entranceTag,serviceOrHandleMethodName:t.serviceTag,methodName:i,argumentOrReturnData:c.arg,info:r,infoType:t.handleTag,isTest:!1,isFirstCallInServiceRun:t.unknownTag,isLastCallInServiceRun:t.unknownTag,link:a,event:t.systemEventName.beforeServiceRun,eventType:t.serviceEventName.before})},function(e){},function(e){}),t.utility.tryCatch(e,function(){return u=l(e,n,r,a,i,c.arg)},function(e){t.track.record({entranceOrExit:t.exitTag,serviceOrHandleMethodName:t.serviceTag,methodName:i,argumentOrReturnData:e,info:"event:success",infoType:t.eventTag,isTest:!1,isFirstCallInServiceRun:t.unknownTag,isLastCallInServiceRun:t.unknownTag,link:a,event:t.systemEventName.onServiceSuccess,eventType:t.serviceEventName.success})},function(e){t.track.record({entranceOrExit:t.exitTag,serviceOrHandleMethodName:t.serviceTag,methodName:i,argumentOrReturnData:e,info:"event:error",infoType:t.eventTag,isTest:!1,isFirstCallInServiceRun:t.unknownTag,isLastCallInServiceRun:t.unknownTag,link:a,event:t.systemEventName.onServiceError,eventType:t.serviceEventName.error})}),u}},d=function(n,r,a){var i="service_";if(0==arguments.length||arguments.length>3)throw"Cannot create service : problem with service definition";if(1==arguments.length){if("function"!=typeof n)return t.registry.scripts[n]?{load:function(e){e&&y(e)}}:(t.registry.scripts[n]=!0,{load:function(e){t.loadScript(n,e&&function(){y(e)})}});a=n,n=t.generateUniqueSystemName(i),r=t.DEFAULT_HANDLE_NAME}if(2==arguments.length){if("function"!=typeof r)throw"service definition has to be a function";a=r,e(n)?(r=n,n=t.generateUniqueSystemName(i)):r=t.DEFAULT_HANDLE_NAME}if(t.isRegistered(n))throw"Unable to create service with name '"+n+"'.Name already exists in registry";t.expectNoForbiddenName(n);var s=a,o={},c=function(e){return c.redefinition(e)};return c.redefinition=T(o,c,r,s,n),c.me=n,t.systemServices[n]=c,t.registry.service[n]={},t.stateFactory(n),n},S=function(e,t,n){for(var r in e)t(r);n()},g=function(e){g.totalChain=g.totalChain||0;var n={},r=void 0;n.result=function(){var e=r;return r=void 0,e};var a=function(e){n[e]=function(e){return function(a){var i={};i.previousOrMostCurrentResultToBePassedToTheNextActor=arguments.length?a:r;var s=JSON.parse(JSON.stringify(i)).previousOrMostCurrentResultToBePassedToTheNextActor;return r=t.systemServices[e](s),n}}(e)};if(e)S(t.systemServices,a,function(){e(n)});else for(var i in t.systemServices)a(i);return n.merge=function(e){var t;if(r)for(var a in r)t=t||{},t[a]=r[a];if(e)for(var a in e)t=t||{},t[a]=e[a];return r=t,n},n},y=function(e){g(function(n){"function"==typeof e&&e.call(t.getCurrentContext(t._GLOBAL_SCOPE_NAME,n),n)})};y.startService=function(e){y(e)},y.handle=function(e,n){var r="handle_";if(0==arguments.length||arguments.length>2)throw"Cannot create handle : problem with handle definition";if(1==arguments.length){if("function"!=typeof e)throw"handle definition has to be a function";n=e,e=t.generateUniqueSystemName(r)}if(t.isRegistered(e))throw"Unable to create handle with name '"+e+"'.Name already exists in registry";return t.expectNoForbiddenName(e),t.registry.handle[e]={},t.handles.push({name:e,definition:n}),t.stateFactory(e),e},y.advanced={test:function(e,n){t._TEST_OBJECTS_=e,n.call(t.getCurrentContext(t._GLOBAL_SCOPE_NAME,g()),g()),t._TEST_OBJECTS_=void 0},play:function(e,n,r){n=n||0,r=r||t.track.records.length-1,y(function(a){for(var i=a,s=n;r>=s;s++){var o=e&&(e||[])[s]||[];if(!o)throw"unable to find service to play service";o.methodType===t.serviceTag&&o.dataType===t.entranceTag&&(i=s===n?i[o.methodName].call(t.getCurrentContext(o.methodName,o.data,o.state),o.data):i[o.methodName]())}i.result()})}},"undefined"==typeof Immutable?y.Immutable={Map:function(e){var n=t.generateUniqueSystemName("immu"),r={data:e};return t.ImmutableStore[n]=JSON.stringify(r),{get:function(e){var r=JSON.parse(t.ImmutableStore[n]);return r.data[e]},set:function(e,r){var a=JSON.parse(t.ImmutableStore[n]);a.data[e]=r;var i=JSON.parse(JSON.stringify(a)).data;return y.Immutable.Map(i)}}}}:y.Immutable=Immutable,y.copy=function(e){y.Immutable.Map({data:e}).get("data")};var E=function(){t.entranceTag="argument",t.exitTag="result",t.serviceTag="service",t.handleTag="handle",t.eventTag="event",t.unknownTag="unknown",t.systemEventName={beforeServiceRun:"beforeServiceRun",afterServiceRun:"afterServiceRun",beforeHandleRun:"beforeHandleRun",afterHandleRun:"afterHandleRun",onServiceError:"onServiceError",onServiceSuccess:"onServiceSuccess",onSystemEvent:"onSystemEvent",onSystemRecordEvent:"onSystemRecordEvent"},t.serviceEventName={before:"before",after:"after",error:"error",success:"success"},t._TEST_OBJECTS_={},t.systemServices={},t.ImmutableStore={},t._STATE_={},t.eventSubscribers={},t.handles=[],t._GLOBAL_SCOPE_NAME=t.generateUniqueSystemName(),t.stateFactory(t._GLOBAL_SCOPE_NAME),t.DEFAULT_HANDLE_NAME=t.generateUniqueSystemName(),y.version="6.0.0",y.service=d,c(y,t.systemEventName.onSystemEvent,t.generateUniqueSystemName()),c(y,t.systemEventName.onSystemRecordEvent,t.generateUniqueSystemName()),c(y,t.systemEventName.beforeServiceRun,t.generateUniqueSystemName()),c(y,t.systemEventName.afterServiceRun,t.generateUniqueSystemName()),c(y,t.systemEventName.beforeHandleRun,t.generateUniqueSystemName()),c(y,t.systemEventName.afterHandleRun,t.generateUniqueSystemName()),c(y,t.systemEventName.onServiceError,t.generateUniqueSystemName()),c(y,t.systemEventName.onServiceSuccess,t.generateUniqueSystemName()),y.handle(t.DEFAULT_HANDLE_NAME,function(e){return e})};return E(),t.system={startRecording:function(){t.recordServices=!0},stopRecording:function(){t.recordServices=!1}},y}():console.log("light script already exists");"undefined"!=typeof module&&"exports"in module&&(module.exports=light),"function"==typeof define&&define.amd&&define("light",[],function(){return light});