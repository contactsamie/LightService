//lightservice 3.0.0
//Samuel B
var light=function(){function e(){for(var e=!1,n=0;n<r.length;n++){try{e=r[n]()}catch(t){continue}break}return e}function n(e){return"[object Array]"===Object.prototype.toString.call(e)}var t={};t.DEFAULT_HANDLE_NAME="$$default",t.entranceTag="argument",t.exitTag="result",t.serviceTag="service",t.handleTag="handle",t.eventTag="event",t.unknownTag="unknown",t._TEST_OBJECTS_,t.systemServices={},t.registry={service:{},handle:{},scripts:{}},t.burnThread=function(e){for(var n=(new Date).getTime()+1e3*e;(new Date).getTime()<=n;);},t.isRegistered=function(e){return t.registry.service[e]||t.registry.handle[e]?!0:!1};var r=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}];t.generateUniqueSystemName=function(e){e=e||"";var n=(e+"_xxxxxxxx_xxxx_4xxx_yxxx_xxxxxxxxxxxx").replace(/[xy]/g,function(e){var n=16*Math.random()|0,t="x"==e?n:3&n|8;return t.toString(16)});return t.isRegistered(n)?t.generateUniqueSystemName(e):n},t.loadScript=function(e,n){n?t.loadScriptAsync(e,n):t.loadScriptSync(e)},t.loadScriptAsync=function(e,n){if(!document)throw"Cannot load script : no document";var t=document.createElement("script");t.src=e,t.onload="function"==typeof n?n:function(){},document.body.appendChild(t)},t.loadScriptSync=function(n){if(!document)throw"Cannot load script : no document";var t=e();t.open("GET",n,!1),t.send("");var r=document.createElement("script");r.type="text/javascript",r.text=t.responseText,document.getElementsByTagName("body")[0].appendChild(r)},t.eventSubscribers={},t.track={record:function(e){if(t.track.records=t.track.records||[],t.recordServices&&e.methodName!==t.DEFAULT_HANDLE_NAME){var n={dataType:e.entranceOrExit,methodType:e.serviceOrHandleMethodName,methodName:e.methodName,time:Date.now?Date.now():(new Date).getTime(),position:t.track.records.length,isFirst:e.isFirstCallInServiceRun,isLast:e.isLastCallInServiceRun,data:e.argumentOrReturnData,isTest:e.isTest||!1,info:e.miscData,infoType:e.miscDataType};n=JSON.parse(JSON.stringify(n)),t.track.records.push(n)}},clearAllRecords:function(){t.track.records=[]}},t.system={getRecord:function(e){return t.track.records=t.track.records||[],t.track.records[e]||[]},getLastRecord:function(){return t.track.records=t.track.records||[],t.track.records.length?t.track.records[t.track.records.length-1]:[]},getAllRecords:function(e){return JSON.parse(JSON.stringify(t.track.records))},recordStart:function(){t.recordServices=!0},recordStop:function(){t.recordServices=!1},recordClear:function(){t.track.clearAllRecords()}},t.utility={},t.utility.execSurpressError=function(e,n,t,r){if(h.event.notify(n,t,r),"function"==typeof e)try{e(n,t,r)}catch(i){console.error("SUPRESSED ERROR : "+i)}},t.utility.tryCatch=function(e,n,r,i){try{var a=n();t.utility.execSurpressError(function(){r(a,e)},null,e,"trying-service")}catch(c){t.utility.execSurpressError(function(){i(c,e)},c,e,"service-throws")}},t.handles=[];var i=function(e,n,r){return i.ref=i.ref||0,i.ref++,t.eventSubscribers[n]=t.eventSubscribers[n]||{},t.eventSubscribers[n].sub=t.eventSubscribers[n].sub||[],t.eventSubscribers[n].sub.push({service:r,ref:i.ref}),i.ref},a=function(e,n,r){t.eventSubscribers[n]=t.eventSubscribers[n]||{},t.eventSubscribers[n].sub=t.eventSubscribers[n].sub||[],t.eventSubscribers[n].notify=t.eventSubscribers[n].notify||function(e,i,a){for(var c=n,s=t.eventSubscribers[c].sub.length,o=0;s>o;o++){var u=t.eventSubscribers[c].sub[o],f={index:o,notificationType:a};r(u,e,i,f)}}},c=function(e,n){return a(e,n,function(e,n,r,i){t.utility.tryCatch(r,function(){return e.service()},function(){},function(){t.utility.execSurpressError(e.service.error,n,r,i)})})},s=function(e,n,t){n[e]=function(n){i(e,t,n)},a(e,t,function(e,n,t,r){if("function"==typeof e)try{e(n,t,r)}catch(i){}})},o=function(e,n,r){s(n,e,r+"."+n),e[n].notify=t.eventSubscribers[r+"."+n].notify},u=function(e,n,r){var a=r+"."+n;e[n]=function(e){return i(r,a,e)},e[n].forEachSubscriber=e[n].forEachSubscriber||function(e){for(var n=t.eventSubscribers[a].sub.length,r=0;n>r;r++){var i=t.eventSubscribers[a].sub[r];e&&e(i)}},c(r,a),e[n].notify=t.eventSubscribers[a].notify},f=function(e,n,r,i,a){var c=t._TEST_OBJECTS_&&t._TEST_OBJECTS_[i]&&t._TEST_OBJECTS_[i].handleName,s=t._TEST_OBJECTS_&&t._TEST_OBJECTS_[i]&&t._TEST_OBJECTS_[i].handle;return t.track.record({entranceOrExit:t.entranceTag,serviceOrHandleMethodName:t.handleTag,methodName:c,argumentOrReturnData:i,miscData:a,miscDataType:t.serviceArgTag,isTest:!0,isFirstCallInServiceRun:t.unknownTag,isLastCallInServiceRun:t.unknownTag,link:s}),tmpDefinition=s.call(t.systemServices,r,a,t.system),t.track.record({entranceOrExit:t.exitTag,serviceOrHandleMethodName:t.handleTag,methodName:c,argumentOrReturnData:i,miscData:t.unknownTag,miscDataType:t.unknownTag,isTest:!0,isFirstCallInServiceRun:t.unknownTag,isLastCallInServiceRun:t.unknownTag,link:s}),tmpDefinition},l=function(e,n,r,i,a,c,s,o){o&&(r=o);for(var u=!1,f=t.handles.length,l=0;f>l;l++){var d=t.handles[l];if(u=r&&d.name===r){t.track.record({entranceOrExit:t.entranceTag,serviceOrHandleMethodName:t.handleTag,methodName:r,argumentOrReturnData:a,miscData:c,miscDataType:t.serviceArgTag,isTest:!1,isFirstCallInServiceRun:t.unknownTag,isLastCallInServiceRun:t.unknownTag,link:s||d.definition}),tmpDefinition=(s||d.definition).call(t.systemServices,i,c,t.system),t.track.record({entranceOrExit:t.exitTag,serviceOrHandleMethodName:t.handleTag,methodName:r,argumentOrReturnData:a,miscData:t.unknownTag,miscDataType:t.unknownTag,isTest:!1,isFirstCallInServiceRun:t.unknownTag,isLastCallInServiceRun:t.unknownTag,link:s||d.definition});break}}return tmpDefinition},d=function(e,n,r,i,a,c){var s,o=t._TEST_OBJECTS_&&t._TEST_OBJECTS_[a]&&t._TEST_OBJECTS_[a].handleName,u=t._TEST_OBJECTS_&&t._TEST_OBJECTS_[a]&&t._TEST_OBJECTS_[a].handle;return s=u&&!o?f(e,n,i,a,c):l(e,n,r,i,a,c,u,o)},v=function(e,r,i,a,c,s){t._TEST_OBJECTS_&&t._TEST_OBJECTS_[c]&&t._TEST_OBJECTS_[c].service&&(i=t._TEST_OBJECTS_[c].handleNames||i,a=t._TEST_OBJECTS_[c].service||a),i=n(i)?i:i?[i]:[];var o,u=i.length;o=s;for(var f=0;u>f;f++){var l=i[f],v=d(e,r,l,a,c,o);if("function"!=typeof v){var T="Cannot process service or handle '"+c+"' ";throw T+=v?"'"+l+"' service handle must return a function":"no matching service handle  exists ",console.error(T),T}o=v.call(t.systemServices,o,S(),t.system)}return o},T=function(e,n,r,i,a){return u(n,"before",a),u(n,"after",a),u(n,"error",a),u(n,"success",a),function(c,s){var o={};o.arg=c;var u;return e.callerContext=s,t.utility.tryCatch(e,function(){return n.before.notify()},function(e){},function(e){}),t.utility.tryCatch(e,function(){return t.track.record({entranceOrExit:t.entranceTag,serviceOrHandleMethodName:t.serviceTag,methodName:a,argumentOrReturnData:o.arg,miscData:r,miscDataType:t.handleTag,isTest:!1,isFirstCallInServiceRun:t.unknownTag,isLastCallInServiceRun:t.unknownTag,link:i}),u=v(e,n,r,i,a,o.arg),t.track.record({entranceOrExit:t.exitTag,serviceOrHandleMethodName:t.serviceTag,methodName:a,argumentOrReturnData:u,miscData:r,miscDataType:t.handleTag,isTest:!1,isFirstCallInServiceRun:t.unknownTag,isLastCallInServiceRun:t.unknownTag,link:i}),u},function(t){return n.success.notify(t,e,"service-success")},function(r){return t.track.record({entranceOrExit:t.exitTag,serviceOrHandleMethodName:t.serviceTag,methodName:a,argumentOrReturnData:r,miscData:"event:error",miscDataType:t.eventTag,isTest:!1,isFirstCallInServiceRun:t.unknownTag,isLastCallInServiceRun:t.unknownTag,link:i}),n.error.notify(r,e,"service-error")}),t.utility.tryCatch(e,function(){return n.after.notify()},function(){},function(){}),u}},m=function(e,r,i){var a="service_";if(0==arguments.length||arguments.length>3)throw"Cannot create service : problem with service definition";if(1==arguments.length){if("function"!=typeof e)return t.registry.scripts[e]?{load:function(e){e&&h(e)}}:(t.registry.scripts[e]=!0,{load:function(n){t.loadScript(e,n&&function(){h(n)})}});i=e,e=t.generateUniqueSystemName(a),r=t.DEFAULT_HANDLE_NAME}if(2==arguments.length){if("function"!=typeof r)throw"service definition has to be a function";i=r,n(e)?(r=e,e=t.generateUniqueSystemName(a)):r=t.DEFAULT_HANDLE_NAME}if(t.isRegistered(e))throw"Unable to create service with name '"+e+"'.Name already exists in registry";var c=function(){var e;return e=i.apply(this,arguments)},s={name:e,step:function(n){h.event.notify(e,s,"service-call"),this.steps.push(n)},steps:[]},o=function(e){return o.redefinition(e)};return o.redefinition=T(s,o,r,c,e),o.me=e,t.systemServices[e]=o,t.registry.service[e]={},e},g=function(e,n,t){for(var r in e)n(r);t()},S=function(e){S.totalChain=S.totalChain||0;var n={},r=void 0;n.result=function(){var e=r;return r=void 0,e};var i=function(e){n[e]=function(e){return function(i){var a=arguments.length?i:r;return r=t.systemServices[e](a),n}}(e)};if(e)g(t.systemServices,i,function(){e(n)});else for(var a in t.systemServices)i(a);return n.merge=function(e){var t;if(r)for(var i in r)t=t||{},t[i]=r[i];if(e)for(var i in e)t=t||{},t[i]=e[i];return r=t,n},n},h=function(e){S(function(n){"function"==typeof e&&e.call(t.systemServices,n,t.system)})};return h.startService=function(e){h(e)},h.handle=function(e,n){var r="handle_";if(0==arguments.length||arguments.length>2)throw"Cannot create handle : problem with handle definition";if(1==arguments.length){if("function"!=typeof e)throw"handle definition has to be a function";n=e,e=t.generateUniqueSystemName(r)}if(t.isRegistered(e))throw"Unable to create handle with name '"+e+"'.Name already exists in registry";return t.registry.handle[e]={},t.handles.push({name:e,definition:n}),e},h.service=m,h.advance={serviceTest:function(e,n){t._TEST_OBJECTS_=e,n.call(t.systemServices,S(),t.system),t._TEST_OBJECTS_=void 0}},h.version=1,o(h,"event","$system"),h.handle(t.DEFAULT_HANDLE_NAME,function(e){return e}),h}();"undefined"!=typeof module&&"exports"in module&&(module.exports=light),"function"==typeof define&&define.amd&&define("light",[],function(){return light});