//lightservice 2.0.1
//Samuel B
var light=function(){function c(){for(var a=!1,c=0;c<b.length;c++){try{a=b[c]()}catch(d){continue}break}return a}function l(a){return"[object Array]"===Object.prototype.toString.call(a)}var a={};a.DEFAULT_HANDLE_NAME="$$default",a._TEST_OBJECTS_,a.systemServices={},a.registry={service:{},handle:{},scripts:{}},a.burnThread=function(a){for(var b=(new Date).getTime()+1e3*a;(new Date).getTime()<=b;);},a.isRegistered=function(b){return a.registry.service[b]||a.registry.handle[b]?!0:!1};var b=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}];a.generateUniqueSystemName=function(b){b=b||"";var c=(b+"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx").replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)});return a.isRegistered(c)?a.generateUniqueSystemName(b):c},a.loadScript=function(b,c){c?a.loadScriptAsync(b,c):a.loadScriptSync(b)},a.loadScriptAsync=function(a,b){if(!document)throw"Cannot load script : no document";var c=document.createElement("script");c.src=a,c.onload="function"==typeof b?b:function(){},document.body.appendChild(c)},a.loadScriptSync=function(a){if(!document)throw"Cannot load script : no document";var b=c();b.open("GET",a,!1),b.send("");var d=document.createElement("script");d.type="text/javascript",d.text=b.responseText,document.getElementsByTagName("body")[0].appendChild(d)},a.eventSubscribers={},a.system={},a.utility={},a.utility.execSurpressError=function(a,b,c,d){if(r.event.notify(b,c,d),"function"==typeof a)try{a(b,c,d)}catch(e){console.error("SUPRESSED ERROR : "+e)}},a.utility.tryCatch=function(b,c,d,e){try{var f=c();a.utility.execSurpressError(function(){d(f,b)},null,b,"trying-service")}catch(g){a.utility.execSurpressError(function(){e(g,b)},g,b,"service-throws")}},a.handles=[];var d=function(b,c,e){return d.ref=d.ref||0,d.ref++,a.eventSubscribers[c]=a.eventSubscribers[c]||{},a.eventSubscribers[c].sub=a.eventSubscribers[c].sub||[],a.eventSubscribers[c].sub.push({service:e,ref:d.ref}),d.ref},e=function(b,c,d){a.eventSubscribers[c]=a.eventSubscribers[c]||{},a.eventSubscribers[c].sub=a.eventSubscribers[c].sub||[],a.eventSubscribers[c].notify=a.eventSubscribers[c].notify||function(b,e,f){for(var g=c,h=a.eventSubscribers[g].sub.length,i=0;h>i;i++){var j=a.eventSubscribers[g].sub[i],k={index:i,notificationType:f};d(j,b,e,k)}}},f=function(b,c){return e(b,c,function(b,c,d,e){a.utility.tryCatch(d,function(){return b.service()},function(){},function(){a.utility.execSurpressError(b.service.error,c,d,e)})})},g=function(a,b,c){b[a]=function(b){d(a,c,b)},e(a,c,function(a,b,c,d){if("function"==typeof a)try{a(b,c,d)}catch(e){}})},h=function(b,c,d){g(c,b,d+"."+c),b[c].notify=a.eventSubscribers[d+"."+c].notify},i=function(b,c,e){var g=e+"."+c;b[c]=function(a){return d(e,g,a)},b[c].forEachSubscriber=b[c].forEachSubscriber||function(b){for(var c=a.eventSubscribers[g].sub.length,d=0;c>d;d++){var e=a.eventSubscribers[g].sub[d];b&&b(e)}},f(e,g),b[c].notify=a.eventSubscribers[g].notify},m=function(b,c,d,e,f){var h=(a._TEST_OBJECTS_&&a._TEST_OBJECTS_[e]&&a._TEST_OBJECTS_[e].handleName,a._TEST_OBJECTS_&&a._TEST_OBJECTS_[e]&&a._TEST_OBJECTS_[e].handle);return a.system.$$currentContext={handles:a.handles,definition:d,serviceName:e,handleName:void 0,arg:f},tmpDefinition=h.call(a.system,d),tmpDefinition},n=function(b,c,d,e,f,g,h,i){i&&(d=i);for(var k=!1,l=a.handles.length,m=0;l>m;m++){var n=a.handles[m];if(k=d&&n.name===d){a.system.$$currentContext={handles:a.handles,definition:e,serviceName:f,handleName:n.name,arg:g},tmpDefinition=(h||n.definition).call(a.system,e);break}}return tmpDefinition},o=function(b,c,d,e,f,g){var h,i=a._TEST_OBJECTS_&&a._TEST_OBJECTS_[f]&&a._TEST_OBJECTS_[f].handleName,j=a._TEST_OBJECTS_&&a._TEST_OBJECTS_[f]&&a._TEST_OBJECTS_[f].handle;return h=j&&!i?m(b,c,e,f,g):n(b,c,d,e,f,g,j,i)},p=function(b,c,d,e,f,g){a._TEST_OBJECTS_&&a._TEST_OBJECTS_[f]&&a._TEST_OBJECTS_[f].service&&(d=a._TEST_OBJECTS_[f].handleNames||d,e=a._TEST_OBJECTS_[f].service||e),d=l(d)?d:d?[d]:[];var i,h=d.length;i=g;for(var j=0;h>j;j++){var k=d[j],m=o(b,c,k,e,f,i);if("function"!=typeof m){var n="Cannot process service or handle '"+f+"' ";throw n+=m?"'"+k+"' service handle must return a function":"no matching service handle  exists ",console.error(n),n}i=m.call(a.system,i,u())}return i},q=function(b,c,d,e,f){return i(c,"before",f),i(c,"after",f),i(c,"error",f),i(c,"success",f),function(g,h){var i={};i.arg=g;var j;return b.callerContext=h,a.utility.tryCatch(b,function(){return c.before.notify()},function(){},function(){}),a.utility.tryCatch(b,function(){return j=p(b,c,d,e,f,i.arg)},function(a){return c.success.notify(a,b,"service-success")},function(a){return c.error.notify(a,b,"service-error")}),a.utility.tryCatch(b,function(){return c.after.notify()},function(){},function(){}),j}},r=function(b){u(function(c){"function"==typeof b&&b.call(a.systemServices,c)})},s=function(b,c,d){if(0==arguments.length||arguments.length>3)throw"Cannot create service : problem with service definition";if(1==arguments.length){if("function"!=typeof b)return a.registry.scripts[b]?{load:function(a){a&&r(a)}}:(a.registry.scripts[b]=!0,{load:function(c){a.loadScript(b,c&&function(){r(c)})}});d=b,b=a.generateUniqueSystemName()}if(2==arguments.length){if("function"!=typeof c)throw"service definition has to be a function";d=c,l(b)?(c=b,b=a.generateUniqueSystemName()):c=a.DEFAULT_HANDLE_NAME}if(a.isRegistered(b))throw"Unable to create service with name '"+b+"'.Name already exists in registry";var e=function(){var a;return a=d.apply(this,arguments)},f={name:b,step:function(a){r.event.notify(b,f,"service-call"),this.steps.push(a)},steps:[]},g=function(a){return g.redefinition(a)};return g.redefinition=q(f,g,c,e,b),g.me=b,a.systemServices[b]=g,a.registry.service[b]={},a.system[b]=function(a){return f.step(b),g.redefinition(a,f)},b},t=function(a,b,c){for(var d in a)b(d);c()},u=function(b){u.totalChain=u.totalChain||0;var c={},d=void 0;c.result=function(){var a=d;return d=void 0,a};var e=function(b){c[b]=function(b){return function(e){var g=arguments.length?e:d;return d=a.systemServices[b](g),c}}(b)};if(b)t(a.systemServices,e,function(){b(c)});else for(var f in a.systemServices)e(f);return c.merge=function(a){var b;if(d)for(var e in d)b=b||{},b[e]=d[e];if(a)for(var e in a)b=b||{},b[e]=a[e];return d=b,c},c};return r.startService=function(b){u(function(c){"function"==typeof b&&b.call(a.systemServices,c)})},r.version=1,h(r,"event","$system"),r.handle=function(b,c){if(0==arguments.length||arguments.length>2)throw"Cannot create handle : problem with handle definition";if(1==arguments.length){if("function"!=typeof b)throw"handle definition has to be a function";c=b,b=a.generateUniqueSystemName()}if(a.isRegistered(b))throw"Unable to create handle with name '"+b+"'.Name already exists in registry";return a.registry.handle[b]={},a.handles.push({name:b,definition:c}),b},r.service=s,r.advance={serviceTest:function(b,c){a._TEST_OBJECTS_=b,c.call(a.systemServices,u()),a._TEST_OBJECTS_=void 0}},r.handle(a.DEFAULT_HANDLE_NAME,function(a){return a}),r}();"undefined"!=typeof module&&"exports"in module&&(module.exports=light),"function"==typeof define&&define.amd&&define("light",[],function(){return light});